import os
import json

RAW_DIR = "data/raw"
PROCESSED_DIR = "data/processed"
CHUNK_SIZE = 400   # approximate words per chunk
CHUNK_OVERLAP = 50 # overlap between chunks

os.makedirs(PROCESSED_DIR, exist_ok=True)

def chunk_text(text: str, size: int = CHUNK_SIZE, overlap: int = CHUNK_OVERLAP):
    """
    Split text into chunks of roughly `size` words with `overlap`.
    """
    words = text.split()
    chunks = []
    start = 0
    while start < len(words):
        end = min(start + size, len(words))
        chunk = " ".join(words[start:end])
        chunks.append(chunk)
        start += size - overlap
    return chunks

def process_files():
    all_chunks = []
    for filename in os.listdir(RAW_DIR):
        if filename.endswith(".md"):
            path = os.path.join(RAW_DIR, filename)
            with open(path, "r", encoding="utf-8") as f:
                text = f.read()
            # Optional: preserve headings as context
            text = text.replace("\n#", "\n\n#")  # simple spacing before headings
            chunks = chunk_text(text)
            for i, chunk in enumerate(chunks):
                all_chunks.append({
                    "source_file": filename,
                    "chunk_id": i,
                    "text": chunk
                })

    output_path = os.path.join(PROCESSED_DIR, "chunks.json")
    with open(output_path, "w", encoding="utf-8") as f:
        json.dump(all_chunks, f, indent=2)

    print(f"Processed {len(all_chunks)} chunks. Saved to {output_path}")

if __name__ == "__main__":
    process_files()
